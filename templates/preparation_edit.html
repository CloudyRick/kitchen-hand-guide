{% extends "base.html" %}

{% block title %}Edit Preparation - Kitchen Hand Guide{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h2 class="mb-0">Edit Preparation</h2>
            </div>
            <div class="card-body">
                {% if !error.is_empty() %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Error!</strong> {{ error }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endif %}

                <form action="/preparation/{{ preparation.id }}/update" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="name" class="form-label">Preparation Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name"
                               value="{{ preparation.name }}" required>
                        <div class="form-text">A clear, descriptive name for this preparation task.</div>
                    </div>

                    <div class="mb-3">
                        <label for="picture" class="form-label">Picture (Optional)</label>
                        {% if !preparation.picture_url.is_empty() %}
                        <div class="mb-2">
                            <img src="{{ preparation.picture_url }}" class="img-thumbnail" style="max-width: 200px;" alt="Current image">
                            <p class="text-muted small">Current image (leave empty to keep this image)</p>
                        </div>
                        {% endif %}
                        <input type="file" class="form-control" id="picture" name="picture" accept="image/jpeg,image/png,image/webp">
                        <div class="form-text">Upload a new image of the preparation (JPG, PNG, or WEBP). This is optional.</div>
                    </div>

                    <div class="mb-3">
                        <label for="prep_type" class="form-label">Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="prep_type" name="prep_type" required>
                            <option value="">Select type...</option>
                            <option value="fruit" {% if preparation.prep_type == "fruit" %}selected{% endif %}>Fruit</option>
                            <option value="bread" {% if preparation.prep_type == "bread" %}selected{% endif %}>Bread</option>
                            <option value="veg" {% if preparation.prep_type == "veg" %}selected{% endif %}>Vegetables</option>
                            <option value="meat" {% if preparation.prep_type == "meat" %}selected{% endif %}>Meat</option>
                            <option value="seafood" {% if preparation.prep_type == "seafood" %}selected{% endif %}>Seafood</option>
                        </select>
                        <div class="form-text">Category of the preparation.</div>
                    </div>

                    <div class="mb-3">
                        <label for="shift" class="form-label">Shift <span class="text-danger">*</span></label>
                        <select class="form-select" id="shift" name="shift" required>
                            <option value="">Select shift...</option>
                            <option value="brekkie" {% if preparation.shift == "brekkie" %}selected{% endif %}>Brekkie</option>
                            <option value="lunch" {% if preparation.shift == "lunch" %}selected{% endif %}>Lunch</option>
                            <option value="both" {% if preparation.shift == "both" %}selected{% endif %}>Both</option>
                        </select>
                        <div class="form-text">Which shift needs this preparation.</div>
                    </div>

                    <div class="mb-3">
                        <label for="location" class="form-label">Location <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="location" name="location"
                               value="{{ preparation.location }}" required>
                        <div class="form-text">Where this preparation task takes place.</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Step-by-Step Instructions <span class="text-danger">*</span></label>
                        <div id="steps-container">
                            <!-- Steps will be loaded here -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addStep()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                            </svg>
                            Add Step
                        </button>
                        <div class="form-text">
                            Add detailed steps with optional images. Be specific about times, temperatures, and safety procedures.
                        </div>
                    </div>

                    <input type="hidden" id="steps" name="steps" value="placeholder">

                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                        <a href="/preparation/{{ preparation.id }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-warning btn-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
                                <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
                            </svg>
                            Update Preparation
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let stepCounter = 0;
let existingSteps = [];

try {
    existingSteps = {{ steps|json|safe }};
    console.log('Loaded existing steps:', existingSteps);
} catch (e) {
    console.error('Error parsing steps JSON:', e);
    existingSteps = [];
}

// Add a new step
function addStep(description = '', imageUrl = '') {
    console.log('addStep called with description:', description, 'imageUrl:', imageUrl);
    stepCounter++;
    const container = document.getElementById('steps-container');

    if (!container) {
        console.error('steps-container not found!');
        return;
    }

    const stepDiv = document.createElement('div');
    stepDiv.className = 'card mb-3 step-card';
    stepDiv.id = `step-${stepCounter}`;

    let imagePreview = '';
    if (imageUrl) {
        imagePreview = `<div class="mb-2"><img src="${imageUrl}" class="img-thumbnail" style="max-width: 150px;"><p class="text-muted small">Current image (upload new to replace)</p></div>`;
    }

    stepDiv.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Step ${stepCounter}</h6>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeStep(${stepCounter})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                </button>
            </div>
            ${imagePreview}
            <div class="mb-2">
                <textarea class="form-control step-description" name="step_description_${stepCounter}" rows="2"
                          placeholder="Describe this step in detail..." required>${description}</textarea>
            </div>
            <div>
                <label class="form-label small">Step Image (Optional)</label>
                <input type="file" class="form-control form-control-sm" name="step_image_${stepCounter}"
                       accept="image/jpeg,image/png,image/webp">
            </div>
        </div>
    `;
    container.appendChild(stepDiv);
    updateStepNumbers();
}

// Remove a step
function removeStep(stepId) {
    const stepDiv = document.getElementById(`step-${stepId}`);
    if (stepDiv) {
        stepDiv.remove();
        updateStepNumbers();
    }
}

// Update step numbers
function updateStepNumbers() {
    const steps = document.querySelectorAll('.step-card');
    steps.forEach((step, index) => {
        const header = step.querySelector('h6');
        if (header) {
            header.textContent = `Step ${index + 1}`;
        }
    });
    updateHiddenStepsField();
}

// Update hidden field
function updateHiddenStepsField() {
    const descriptions = Array.from(document.querySelectorAll('.step-description'))
        .map((textarea, index) => `${index + 1}. ${textarea.value}`)
        .join('\n');
    document.getElementById('steps').value = descriptions || 'placeholder';
}

// Form submission handler
document.querySelector('form').addEventListener('submit', function(e) {
    const stepsCount = document.querySelectorAll('.step-card').length;
    if (stepsCount === 0) {
        e.preventDefault();
        alert('Please add at least one step to the preparation.');
        return false;
    }
    updateHiddenStepsField();
});

// Load existing steps on page load
window.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded fired, existingSteps:', existingSteps);

    if (existingSteps && Array.isArray(existingSteps) && existingSteps.length > 0) {
        console.log('Loading', existingSteps.length, 'existing steps');
        existingSteps.forEach((step, index) => {
            console.log('Adding step', index + 1, ':', step);
            addStep(step.description || '', step.picture_url || '');
        });
    } else {
        console.log('No existing steps found, adding one empty step');
        addStep(); // Add one empty step if no existing steps
    }

    console.log('Finished loading steps, total step cards:', document.querySelectorAll('.step-card').length);
});
</script>

<style>
.step-card {
    border-left: 4px solid #ffc107;
}
</style>
{% endblock %}
